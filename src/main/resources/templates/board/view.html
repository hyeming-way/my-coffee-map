<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">

<head>
    <title th:text="${board.title}">詳細を見る</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <link th:href="@{/css/main.css}" rel="stylesheet">
    <style>
        .text-brown {
            color: #8B4513;
        }

        .btn-outline-primary {
            color: #8B4513;
            border-color: #c8a974;
        }

        .btn-outline-primary:hover {
            background-color: #c8a974;
            border-color: #c8a974;
            color: white;
        }

        .btn-outline-secondary {
            color: #5c4435;
            border-color: #c8a974;
        }

        .btn-outline-secondary:hover {
            background-color: #c8a974;
            border-color: #c8a974;
            color: white;
        }

        .btn-outline-danger {
            color: #d86a6a;
            border-color: #d86a6a;
        }

        .btn-outline-danger:hover {
            background-color: #d86a6a;
            color: white;
        }

        .card.bg-light {
            background-color: #f9f6f0 !important;
        }

        .fw-bold {
            color: #5c4435;
        }

        .btn-sm {
            font-size: 0.85rem;
            padding: 0.25rem 0.6rem;
        }
        
        .btn-rounded {
		    border-radius: 20px !important;
		}

        .img-fluid.rounded {
            border: 1px solid #e3d6c5;
            box-shadow: 0 2px 4px rgba(139, 69, 19, 0.1);
        }
        
	    .btn-coffee {
	        background-color: #c8a974;
	        color: white;
	        border: none;
	        border-radius: 20px;
	        padding: 0.25rem 1rem;
	        transition: background-color 0.3s ease;
	    }
	
	    .btn-coffee:hover {
	        background-color: #b59261;
	        color: white;
	    }
	
	    .btn-coffee-light {
	        background-color: #e3d6c5;
	        color: #5c4435;
	        border: none;
	        border-radius: 20px;
	        padding: 0.25rem 1rem;
	        transition: background-color 0.3s ease;
	    }
	
	    .btn-coffee-light:hover {
	        background-color: #d6c3ad;
	        color: #3e2d22;
	    }
	
	    .btn-coffee i,
	    .btn-coffee-light i {
	        margin-right: 4px;
	    }
   
    </style>
</head>

<div layout:fragment="content">
    <div class="container mt-5" style="max-width: 800px;">
        <h3 class="mb-3" th:text="${board.title}">タイトル</h3>

        <!-- 작성자 정보 -->
        <div class="d-flex align-items-center justify-content-between mb-2">
            <div class="d-flex align-items-center">
                <img th:src="${board.user.profileImg != null} ? @{'/profiles/' + ${board.user.profileImg}} : @{/images/icon/basic_profile.jpg}"
                     style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;" alt="プロフィール">
                <span class="ms-2 fw-bold" th:text="${board.user.nick + ' さん'}">ニックネーム</span>
            </div>

            <div th:if="${session.user != null and session.user.id == board.user.id}" class="mt-3">
                <a th:href="@{/board/edit/{id}(id=${board.id})}" class="btn btn-sm btn-rounded btn-outline-primary me-2">
                    <i class="bi bi-pencil-square me-1"></i>編集
                </a>
                <form th:action="@{/board/delete/{id}(id=${board.id})}" method="post" th:object="${board}" style="display:inline;">
                    <button type="submit" class="btn btn-sm btn-rounded btn-outline-danger"
                            onclick="return confirm('本当に削除しますか？');">
                        <i class="bi bi-trash-fill me-1"></i>削除
                    </button>
                </form>
            </div>
        </div>

        <div class="mb-3 text-muted small" th:text="${#temporals.format(board.createdAt, 'yyyy.MM.dd HH:mm')}">投稿日</div>

        <!-- 첨부 이미지 -->
        <img th:src="@{/boards/{filename}(filename=${board.imageUrl})}"
             class="img-fluid rounded" alt="添付画像"
             style="max-height: 400px; object-fit: contain; display: block; margin: 0 auto;"
             onerror="this.src='/images/default.png'" />

        <!-- 본문 -->
        <div class="mb-4" th:text="${board.content}">本文</div>

        <!-- 관련 정보 -->
        <div class="mb-4">
            <div class="card bg-light border-0 shadow-sm">
                <div class="card-body">
                    <h6 class="card-title fw-bold mb-3">関連情報</h6>

                    <div th:if="${board.bean != null}" class="mb-2 d-flex align-items-center">
                        <i class="bi bi-cup-straw me-2 text-brown"></i>
                        <span class="fw-bold">関連コーヒー豆：</span>
                        <span class="ms-1 text-muted" th:text="${board.bean.name + '（' + board.bean.origin + '）'}"></span>
                    </div>

                    <div th:if="${board.cafe != null}" class="d-flex align-items-center">
                        <i class="bi bi-geo-alt-fill me-2 text-danger"></i>
                        <span class="fw-bold">関連カフェ：</span>
                        <span class="ms-1 text-muted" th:text="${board.cafe.name + '（' + board.cafe.address + '）'}"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 별점 -->
        <div class="mb-3">
            <strong>評価：</strong>
            <span th:each="i : ${#numbers.sequence(1, 5)}">
                <i class="bi" th:classappend="${i <= board.rating} ? 'bi-star-fill text-warning' : 'bi-star text-secondary'"></i>
            </span>
        </div>

        <!-- 좋아요 -->
        <div class="mb-4">
            <div class="d-flex align-items-center">
                <form th:if="${session.user != null}" th:action="@{/board/like}" method="post" class="me-2 mb-0">
                    <input type="hidden" name="boardId" th:value="${board.id}" />
                    <button type="submit" class="btn btn-sm p-0 border-0 bg-transparent">
                        <i class="bi bi-heart-fill fs-4"
                           th:classappend="${liked} ? 'text-danger' : 'text-secondary'"></i>
                    </button>
                </form>

                <div th:if="${session.user == null}" class="me-2">
                    <i class="bi bi-heart-fill fs-4"
                       th:classappend="${likeCount > 0} ? 'text-danger' : 'text-secondary'"></i>
                </div>

                <div class="text-muted small" th:text="${likeCount + ' いいね！'}">0 いいね！</div>
            </div>

            <div th:if="${session.user == null}" class="text-muted small mt-1">
                ※ログイン後「いいね！」できます。
            </div>
        </div>

        <!-- 댓글 목록 -->
        <div class="mt-4">
            <h6>コメント</h6>
            <div th:each="comment : ${comments}" class="comment-box mb-3 p-2 border rounded">
                <p class="mb-1">
                    <strong th:text="${comment.user.nick}"></strong>
                    <form th:if="${session.user != null and editingCommentId == comment.id}" 
                          th:action="@{/comment/edit}" method="post" class="d-inline w-100">
                        <input type="hidden" name="commentId" th:value="${comment.id}" />
                        <input type="hidden" name="boardId" th:value="${board.id}" />
                        <textarea name="content" class="form-control mb-1" rows="2" required 
                                  th:text="${comment.content}"></textarea>
                        <button type="submit" class="btn btn-sm btn-outline-primary me-1">保存</button>
                        <a th:href="@{/board/{id}(id=${board.id})}" class="btn btn-sm btn-outline-secondary">キャンセル</a>
                    </form>
                    <span th:if="${editingCommentId != comment.id}" th:text="${comment.content}"></span>
                </p>
                <small>
                    <span th:text="${#temporals.format(comment.createdAt, 'yyyy-MM-dd HH:mm')}"></span>
                    <span th:if="${comment.updatedAt != null and comment.updatedAt != comment.createdAt}" class="text-muted small">
                        <i class="bi bi-pencil"></i>
                        <span th:text="${#temporals.format(comment.updatedAt, 'yyyy-MM-dd HH:mm')}"></span>
                    </span>
                </small>

                <div class="mt-1">
				    <!-- 수정 버튼 -->
				    <a th:if="${session.user != null and session.user.id == comment.user.id}" 
				       th:href="@{/board/{id}(id=${board.id}, edit=${comment.id})}"
				       class="btn btn-sm btn-rounded btn-outline-primary me-1">
				        <i class="bi bi-pencil-square me-1"></i>編集
				    </a>
				
				    <!-- 삭제 버튼 -->
				    <form th:if="${session.user != null and 
				                 (session.user.id == comment.user.id or session.user.id == board.user.id)}"
				          th:action="@{/board/comment/{id}/delete(id=${comment.id})}" 
				          method="post" style="display:inline;">
				        <button type="submit" class="btn btn-sm btn-rounded btn-outline-danger"
				                onclick="return confirm('コメントを削除しますか？');">
				            <i class="bi bi-trash-fill me-1"></i>削除
				        </button>
				    </form>
				</div>
            </div>
        </div>

        <!-- 댓글 작성 -->
		<div class="mb-4">
		    <form th:action="@{'/board/' + ${board.id} + '/comment'}" method="post" th:if="${session.user != null}">
		        <textarea name="content" class="form-control mb-2" rows="2" placeholder="コメントを入力してください" required></textarea>
		        <button type="submit" class="btn btn-sm btn-coffee">
				    <i class="bi bi-chat-dots"></i>投稿
				</button>
		    </form>
		    <div th:if="${session.user == null}" class="text-muted small">※ログイン後コメントできます。</div>
		</div>
		
		<!-- 목록으로 -->
		<div class="text-end mt-4 mb-5">
		    <a th:href="@{/board/list}" class="btn btn-sm btn-coffee-light">
			    <i class="bi bi-list-ul"></i>リストに進む
			</a>
		</div>
    </div>
</div>
</html>
