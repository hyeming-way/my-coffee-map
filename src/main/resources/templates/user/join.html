<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
<title>join</title>
<link th:href="@{/css/user/join.css}" rel="stylesheet">
</head>
<body>
<div layout:fragment="content">
	<form th:action="@{/user/join}" th:object="${JoinForm}" method="post" id="joinForm" enctype="multipart/form-data">
	    <table>
	    <tr>
	        <td><h2 class="join-title">新規会員登録</h2></td>
	    </tr>	
	    <tr><td><p class="join-txt">プロフィール画像</p></td></tr>
	    <tr><td>
	    	<img id="profileImg" class="profile-img" th:src="@{/images/icon/basic_profile.jpg}" alt="プロフィール画像">
			<input type="hidden" id="profileImgInput" th:value="@{/images/icon/basic_profile.jpg}">
			<div class="profile-img-wrap">
				<label for="imgUpload" class="profile-camera">
					<img th:src="@{/images/icon/camera_icon.svg}" alt="写真アップロードアイコン">
				</label>
				<input type="file" id="imgUpload" name="imgUpload" accept="image/*" onchange="uploadImg(this)">
	   		</div>
	    </td></tr>
	    <tr><td><p class="join-txt"><span>*</span>メールアドレス</p></td></tr>
	    <tr><td>
	    	<input type="text" class="text" th:field="*{email}" id="email">
	    	<p id="emailError" class="join-error-msg"></p>
	    </td></tr>
	    <tr><td><p class="join-txt"><span>*</span>パスワード</p></td></tr>
	    <tr><td>
	    	<input type="password" class="text" th:field="*{pass}" id="pass">
	    	<p id="passError" class="join-error-msg"></p>
	    </td></tr>
	    <tr><td><p class="join-txt"><span>*</span>パスワード確認</p></td></tr>
	    <tr><td>
	    	<input type="password" class="text" th:field="*{passCheck}" id="passCheck">
	    	<p id="passCheckError" class="join-error-msg"></p>
	    </td></tr>
	    <tr><td><p class="join-txt"><span>*</span>ニックネーム</p></td></tr>
	    <tr><td>
	    	<input type="text" class="text" th:field="*{nick}" id="nick">
	    	<p id="nickError" class="join-error-msg"></p>
	    </td></tr>
	    <tr><td>
	    	<input type="submit" value="送信" class="submit-btn">
	    	<p class="loading-msg">
	    		<img id="loadingGif" th:src="@{/images/icon/loading-cup.gif}" alt="Loading..."> 
	    		<span style="color: #333;">少々お待ちください。</span>
	    	</p>
	    </td></tr>
	    <tr><td>    
	    	<p class="join-msg"><span>*</span>は必須項目です。すべて入力してください。</p>
	    </td></tr>
	    </table>
	</form>
	
	<script>		
		document.addEventListener('DOMContentLoaded', function () {	
			//프로필 사진 업로드
			function uploadImg(input) {
				const file = input.files[0];
				if (!file) return;
				
				const allowedTypes = ['image/jpeg', 'image/png', 'image/gif'];
				if (!allowedTypes.includes(file.type)) {
				    alert("(JPEG, PNG, GIF)ファイルのみアップロード可能です。");
				    input.value = "";
				    return;
				}
				
				const reader = new FileReader();
				reader.onload = function (e) {
				    document.getElementById('profileImg').src = e.target.result;
				    document.getElementById('profileImgInput').value = file.name;
				}
				reader.readAsDataURL(file);
			}		
			window.uploadImg = uploadImg;
			
			
		//회원가입 유효성 검사 ---------------------------------------------------------------------
		const email = document.getElementById("email");
		const pass = document.getElementById("pass");
		const passCheck = document.getElementById("passCheck");
		const nickname = document.getElementById("nick");
		
		email.addEventListener("input", validateEmail);
		pass.addEventListener("input", validatePass);
		passCheck.addEventListener("input", validatePassCheck);
		nickname.addEventListener("input", validateNick);
		
			//이메일 유효성 검사
			function validateEmail() {
			  const emailValue = email.value.trim();
			  const error = document.getElementById("emailError");
			  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
			
			  if (!emailValue) {
			    error.textContent = "メールアドレスを入力してください。";
			  } else if (!emailRegex.test(emailValue)) {
			    error.textContent = "メールアドレスの形式が正しくありません。";
			  } else {
			    checkEmailDuplication(emailValue); //이메일 중복 검사 함수 호출
			  }
			}
			
			//실시간 이메일 중복 검사
			function checkEmailDuplication(email) {
				fetch("/user/checkEmail?email=" + email)
					.then(response => response.json())
					.then(isAvailable => {
						const error = document.getElementById("emailError");
						if (!isAvailable) {
							error.textContent = "このメールアドレスは既に使用されています。";
						} else {
							error.textContent = "";
						}
					})
					.catch(err => {				
						console.error("이메일 중복 확인 실패", err);
					});
			}

			//패스워드 유효성 검사
			function validatePass() {
			  const pw = pass.value.trim();
			  const error = document.getElementById("passError");
			
			  if (!pw) {
			    error.textContent = "パスワードを入力してください。";
			  } else if (pw.length < 8 || pw.length > 20) {
			    error.textContent = "パスワードは8〜20文字で入力してください。";
			  } else {
			    error.textContent = "";
			  }		
			  validatePassCheck();
			}
			
			//패스워드 재확인 유효성 검사
			function validatePassCheck() {
			  const pw = pass.value.trim();
			  const pwCheck = passCheck.value.trim();
			  const error = document.getElementById("passCheckError");
			
			  if (pw !== pwCheck) {
			    error.textContent = "パスワードが一致しません。";
			  } else if (!pwCheck) {
			    error.textContent = "パスワードを確認してください。";
			  }else {
			    error.textContent = "";
			  }
			}
			
			//닉네임 유효성 검사
			// - 히라가나, 가타카나, 한자, 장음, 영문, 숫자 사용 가능. 그 외 사용 불가
			function validateNick() {
			  const nick = nickname.value.trim();
			  const error = document.getElementById("nickError");
			  const specialCharRegex = /^[\u4E00-\u9FFF\u3040-\u309F\u30A0-\u30FF\u30FCa-zA-Z0-9]{2,10}$/;
	
			  if (!nick) {
			    error.textContent = "ニックネームを入力してください。";
			  } else if (nick.length < 2 || nick.length > 10) {
			    error.textContent = "ニックネームは2〜10文字で入力してください。";
			  } else if (!specialCharRegex.test(nick)) {
			    error.textContent = "ニックネームに空白や記号は使えません。";
			  } else {
				checkNickDuplication(nick);
			  }
			}
			
			//실시간 닉네임 중복 검사
			function checkNickDuplication(nick) {
				fetch("/user/checkNick?nick=" + nick)
					.then(response => response.json())
					.then(isAvailable => {
						const error = document.getElementById("nickError");
						if (!isAvailable) {
							error.textContent = "このニックネームは既に使用されています。";
						} else {
							error.textContent = "";
						}
					})
					.catch(err => {				
						console.error("닉네임 중복 확인 실패", err);
					});
			}
			
		//submit
		const form = document.getElementById("joinForm");
			form.addEventListener("submit", function (e) {		  
			  validateEmail();
			  validatePass();
			  validatePassCheck();
			  validateNick();
			
			  const hasError = document.querySelectorAll(".join-error-msg") ? 
					  			Array.from(document.querySelectorAll(".join-error-msg")).some(p => p.textContent !== "") : false;
					  			//.some() : 배열 안에 조건을 만족하는 요소가 하나라도 있으면 true를 반환 
			
			  if (hasError) {
				  e.preventDefault(); 
			  } else {
				  const submitBtn = document.querySelector(".submit-btn");
				  const joinMsg = document.querySelector(".join-msg");
				  const loadingMsg = document.querySelector(".loading-msg");
				  
				  submitBtn.style.display = "none";
				  joinMsg.style.display = "none";
				  loadingMsg.style.display = "block";
			  }
		  			
			});
				
		}); //document.addEventListener('DOMContentLoaded'
			
	</script>	
</div>
</body>
</html>